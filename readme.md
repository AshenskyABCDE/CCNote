智林笔记——用他人的经验来让您少走弯路



# 实现逻辑：

## 1.短信登录的实现

### 1.1 实现逻辑简述

对于浏览器登录来说，是通过session缓存数据的，而用户名可以存放在我们的数据库里，因此 当我们生成验证码的时候可以把验证码先存放在session里再发送。之后我们可以用用户填写的验证码和session里的比较来判断填写是否正确。

当然对于错误的填写，我们要发送相关的提示，对登录也要有拦截功能。



### 1.2 登录校验的逻辑

这里通过session获取user 也就是用户，如果用户不存在对登录进行拦   截，之后无论是新注册的还是之前有的都存放到ThreadLocal里

### 1.3 解决session共享问题

问题出现：多台tomcat并不共享session存储空间，当请求切换到不同tomcat服务器导致数据丢失。

应该从 数据共享，内存存储，key-value结构方面考虑。

因此我们可以在生成验证码的时候，保存验证码到redis中。

我们可以将手机号作为key 验证码作为value，就不用带着信息来取，只需要在redis去get 手机号就行。同时我们也将随机token作为key来存储用户数量。其中用String在内存 性能上会有问题，我们可以考虑用Hash实现



### 1.3 改进

（1） 在session中的user 实际上只有少数是有用的属性，如果每次传参的属性都是user的话，会造成大量的内存浪费，以及在安全上出现一些问题，所以封装成userDTO。

（2） 如果token的有效期只有三十分钟，用户在浏览的情况下，三十分钟后也要再登录，所以我们应该再设置一个拦截器。

解决办法 就是设置两个拦截器，第一个拦截器拦截所有路径，在这里有存储用户信息和刷新token的作用，第二个拦截器拦截登录页面从而判断是否要登录，这样只要访问一个页面就会刷新token。

### 1.4 小结

对需要登录的时候，拦截器会选获取token，然后查询redis的用户是否存在，将信息保存到ThreadLocal，并刷新token的有效期。

